25a26,27
> #export HOMEgfs=${HOMEgfs:-"/home/Bo.Huang/JEDI-2020/expRuns/exp_UFS-Aerosols/cycExp_ATMA_warm/"}
> #export EXPDIR=${EXPDIR:-"${HOMEgfs}/dr-work/"}
40a43,45
> 
> #export ROTDIR=/scratch2/BMC/gsd-fv3-dev/MAPP_2018/bhuang/JEDI-2020/JEDI-FV3/expRuns/exp_UFS-Aerosols/cycExp_ATMA_warm/dr-data/
> #export CDATE=2017110106
45,46d49
< export HOMEgfs=${HOMEgfs:-"/home/Bo.Huang/JEDI-2020/expRuns/exp_UFS-Aerosols/cycExp_ATMA_warm/"}
< export EXPDIR=${EXPDIR:-"${HOMEgfs}/dr-work/"}
55a59,60
> export ENSGRP=${ENSGRP:-"01"}
> export NMEM_EFCSGRP=${NMEM_EFCSGRP:-"5"}
57c62
< export job="calcinc"
---
> export job="calcensinc"
62a68,70
> ENSED=$((${NMEM_EFCSGRP} * 10#${ENSGRP}))
> ENSST=$((ENSED - NMEM_EFCSGRP + 1))
> 
87c95
< ${NRM} atmges_mem001 atmanl_mem001 atminc_mem001 calc_increment.nml
---
> 
91,98c99,111
< mkdir -p $ROTDIR/${CDUMP}.${CYMD}/${CH}/${COMPONENT}/
< BKGFILE=${ROTDIR}/${CDUMP}.${GYMD}/${GH}/${COMPONENT}/${CDUMP}.t${GH}z.atmf${FHR}.nc 
< INCFILE=${ROTDIR}/${CDUMP}.${CYMD}/${CH}/${COMPONENT}/${CDUMP}.t${CH}z.atminc.nc
< ANLFILE=${GDASDIR}/${CDUMP}.${CDATE}/${CDUMP}.t${CH}z.atmanl.${CASE_CNTL}.nc
< 
< ${NLN} ${BKGFILE} atmges_mem001
< ${NLN} ${ANLFILE} atmanl_mem001
< ${NLN} ${INCFILE} atminc_mem001
---
> IMEM=${ENSST}
> while [ ${IMEM} -le ${ENSED} ]; do
>     MEMSTR="mem"`printf %03d ${IMEM}`
>     ${NRM} atmges_mem001 atmanl_mem001 atminc_mem001 calc_increment.nml
> 
>     mkdir -p $ROTDIR/enkf${CDUMP}.${CYMD}/${CH}/${COMPONENT}/${MEMSTR}/
>     BKGFILE=${ROTDIR}/enkf${CDUMP}.${GYMD}/${GH}/${COMPONENT}/${MEMSTR}/${CDUMP}.t${GH}z.atmf${FHR}.nc 
>     INCFILE=${ROTDIR}/enkf${CDUMP}.${CYMD}/${CH}/${COMPONENT}/${MEMSTR}/${CDUMP}.t${CH}z.ratminc.nc
>     ANLFILE=${GDASDIR}/enkf${CDUMP}.${CDATE}/${MEMSTR}/${CDUMP}.t${CH}z.ratmanl.${MEMSTR}.${CASE_CNTL}.nc
> 
>     ${NLN} ${BKGFILE} ./atmges_mem001
>     ${NLN} ${ANLFILE} ./atmanl_mem001
>     ${NLN} ${INCFILE} ./atminc_mem001
115c128
< cat calc_increment.nml
---
>     cat calc_increment.nml
117,127c130,134
< srun --export=all -n ${ncmd} ./calc_inc.x
< ERR=$?
< if [[ $ERR != 0 ]]; then
<     exit ${ERR}
< fi
< #export ERR=$rc
< #export err=$ERR
< #$ERRSCRIPT || exit 3
< #unlink atmges_mem001
< ##unlink atmanl_mem001
< unlink atminc_mem001
---
>     srun --export=all -n ${ncmd} ./calc_inc.x
>     ERR=$?
>     [[ $ERR != 0 ]] && exit ${ERR}
>     IMEM=$((IMEM+1))
> done
130c137
< rm -rf ${DATA}/calcinc.$$
---
> rm -rf ${DATA}/calcensinc.$$
